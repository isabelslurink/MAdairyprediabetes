---
  title: "Dairy intake in relation to prediabetes and continuous glycemic outcomes: a systematic review and dose-response meta-analysis of prospective cohort studies"
author: "Isabel Slurink"
date: "14-12-2023"
output:
  html_document:
  toc: true
toc_float: true
---
  <style type="text/css">
  body{ 
    font-size: 12pt;
  }
</style>
  
```{r setup, include=FALSE}
# Load in libPath
.libPaths("C:/Users/islurink/OneDrive - Tilburg University/Documents/R-4.0.2")
options(scipen=999)

# Generate seed for reproducibility
set.seed(2345)
```

```{r load-packages, include=FALSE}
library("dosresmeta")
library("readxl")
library("dplyr")
library("rms")
library("ggplot2")
library("tidyr")
library("metafor")
library("tidyverse")
library("metasens")
library("kableExtra")
```

```{r knitr options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(echo = TRUE)
```

# Load in dataset and run characteristics

```{r load-data, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# Clear environment
rm(list=ls())

# Load in dataset
data_1 <- read_excel("C:/Users/islurink/OneDrive - Tilburg University/Documents/Projecten/DiaryPreDM_project/Meta-analysis/2. Analyse/Extraction form/DataExtractionForm_v2.xlsx", sheet = 4)
data_mod <- read_excel("C:/Users/islurink/OneDrive - Tilburg University/Documents/Projecten/DiaryPreDM_project/Meta-analysis/2. Analyse/Extraction form/DataExtractionForm_v2.xlsx", sheet = 1)

data_mod <- data_mod %>% dplyr::select(ID, studyname, studyname_abv, country, age,
                                       sex, BMI, FU_duration,
                                       moderator_yeardairyintake,
                                       moderator_countrySES,
                                       moderator_dietary_assessment,
                                       moderator_prediabetes_assesment) %>% filter(!is.na(moderator_prediabetes_assesment)) %>%
  mutate(country = factor(country),
         age = as.numeric(age),
         sex = as.numeric(sex),
         BMI = as.numeric(BMI),
         FU_duration = as.numeric(FU_duration),
         moderator_yeardairyintake  = as.numeric(moderator_yeardairyintake) - min(moderator_yeardairyintake),
         moderator_countrySES = factor(moderator_countrySES),
         moderator_dietary_assessment = factor(moderator_dietary_assessment),
         moderator_prediabetes_assesment = factor(moderator_prediabetes_assesment)
  )

data_2 <- data_1 %>% filter(!is.na(ID) & outcome=="prediabetes") %>% dplyr::select(!c(outcome, outcome_datatype, outcome_FUchange, exposure_baselinechange , outcome,
                                                                                      intake_midpoint, intake_range_LL, intake_range_UL, intake_averaged, unit, intake_conversion, effectestimate_type))
data_2 <- data_2 %>% mutate(logrr = log(effectestimate),
                            author = factor(author),
                            ID = as.integer(ID),
                            id = factor(studyname),
                            cases = as.integer(N_cat_cases),
                            type =  factor("ci"),
                            n = as.integer(N_cat_total),
                            dose = intake_midpoint_gram,
                            se = log(UB) - log(LB) / (2 * 1.96)
) 

data_3 <- merge(data_2, data_mod, by = "studyname")

data_3 <- data_3 %>% mutate(dose = ifelse(exposure == "milk_tot", dose/150, dose),
                            dose = ifelse(exposure == "milk_hf", dose/150, dose),
                            dose = ifelse(exposure == "milk_lf", dose/150, dose),
                            dose = ifelse(exposure == "yogurt_tot", dose/150, dose),
                            dose = ifelse(exposure == "yogurt_hf", dose/150, dose),
                            dose = ifelse(exposure == "yogurt_lf", dose/150, dose),
                            dose = ifelse(exposure == "cheese_tot", dose/20, dose),
                            dose = ifelse(exposure == "cheese_hf", dose/20, dose),
                            dose = ifelse(exposure == "cheese_lf", dose/20, dose),
                            dose = ifelse(exposure == "cream_tot", dose/15, dose),
                            dose = ifelse(exposure == "creamice_tot", dose/150, dose))

# Select categorical RRs from fully adjusted model
data_4 <- data_3 %>% filter(exposure_cat != "continious" & confounder_model == "4") 

data_4$standard_error <- (data_4$UB - data_4$LB) / (2 * qnorm(0.975))
```

# Descriptive for the exposure distributions

```{r Descriptive for the exposure distributions}

# Descriptive for the exposure distributions
out_chr <- data_4 %>%
  group_by(exposure, id) %>%
  summarise(min = min(dose), p25 = quantile(dose, .25),
            median = median(dose), p75 = quantile(dose, .75), max = max(dose),
            n_tot = sum(n), n_cases = sum(N_cat_cases), FU_duration = mean(FU_duration)) %>% group_by(exposure) %>%
  summarise(min = min(median),
            max = max(median), 
            sum_n = sum(n_tot),
            sum_cases = sum(n_cases),
            mean = mean(FU_duration))
out_chr
out_chr <- data_4 %>%
  group_by(exposure, id) %>%
  summarise(min = min(dose), p25 = quantile(dose, .25),
            median = median(dose), p75 = quantile(dose, .75), max = max(dose),
            n_tot = sum(n), n_cases = sum(N_cat_cases), FU_duration = mean(FU_duration))
out_chr
```

# Total dairy

```{r indiviual meta-analysis dairy_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data dairy_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison dairy_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction dairy_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r dairy_tot model fit plot dairy_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "dairy_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest dairy_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r dairy_tot forest dairy_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r dairy_tot publication plot dairy_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4, 1.6)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r dairy_tot dosres plot lin dairy_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r dairy_tot dosres plot quad dairy_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

## Moderation

```{r moderation analysis dairy_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "dairy_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators dairy_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r dairy_tot confounders dairy_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_tot" & confounder_model == "1") 
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_tot" & confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_tot" & confounder_model == "3") 
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_tot" & confounder_model == "4") 
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r dairy_tot sensitivity analysis dairy_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl dairy_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed model data dairy_tot}
df <- data_4 %>% filter(exposure == "dairy_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# High-fat dairy

```{r indiviual meta-analysis dairy_hf}
# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data dairy_hf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison dairy_hf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction dairy_hf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r dairy_hf model fit plot dairy_hf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "dairy_hf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest dairy_hf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r dairy_hf forest dairy_hf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r dairy_hf publication plot dairy_hf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.75, .9, 1, 1.1, 1.3)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r dairy_hf dosres plot lin dairy_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("High-fat dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r dairy_hf dosres plot quad dairy_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("High-fat dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis dairy_hf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "dairy_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators dairy_hf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r dairy_hf confounders dairy_hf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_hf" & confounder_model == "1") 
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_hf" & confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_hf" & confounder_model == "3") 
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_hf" & confounder_model == "4") 
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_hf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r dairy_hf sensitivity analysis dairy_hf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_hf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_hf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl dairy_hf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 2, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

## Fixed effect sensitivity analysis

```{r fit fixed model data dairy_hf}
df <- data_4 %>% filter(exposure == "dairy_hf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

# Low-fat dairy

```{r indiviual meta-analysis dairy_lf}
# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data dairy_lf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison dairy_lf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction dairy_lf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r dairy_lf model fit plot dairy_lf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "dairy_lf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

```{r highest lowest dairy_lf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r dairy_lf forest dairy_lf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r dairy_lf publication plot dairy_lf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .08), atransf=exp, at=log(c(.8, .9, 1, 1.1, 1.2)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r dairy_lf dosres plot lin dairy_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))  + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

```{r dairy_lf dosres plot quad dairy_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis dairy_lf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "dairy_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators dairy_lf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r dairy_lf confounders dairy_lf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_lf" & confounder_model == "1") 
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_lf" & confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_lf" & confounder_model == "3") 
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_3 %>% filter(exposure_cat != "continious" & exposure == "dairy_lf" & confounder_model == "4") 
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_lf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r dairy_lf sensitivity analysis dairy_lf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "dairy_lf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_lf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl dairy_lf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed model data dairy_lf}
df <- data_4 %>% filter(exposure == "dairy_lf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="dairy_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 3, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```


# Fermented dairy

```{r indiviual meta-analysis fermented_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data fermented_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison fermented_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction fermented_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r fermented_tot model fit plot fermented_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "fermented_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest fermented_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r fermented_tot forest fermented_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 9.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r fermented_tot publication plot fermented_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.75, .9, 1, 1.1, 1.3)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r fermented_tot dosres plot lin fermented_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("Fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()
  )

```

```{r fermented_tot dosres plot quad fermented_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("Fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis fermented_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "fermented_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators fermented_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r fermented_tot confounders fermented_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "fermented_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r fermented_tot sensitivity analysis fermented_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) # Not in dataset
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:8) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame # "FHS-OC", 
studyname_abv <- c("AD", "FS","HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:8) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl fermented_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data fermented_tot}
df <- data_4 %>% filter(exposure == "fermented_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 4, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# High-fat fermented dairy

```{r indiviual meta-analysis fermented_hf}
# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data fermented_hf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison fermented_hf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction fermented_hf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r fermented_hf model fit plot fermented_hf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "fermented_hf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest fermented_hf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r fermented_hf forest fermented_hf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 8.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r fermented_hf publication plot fermented_hf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .15), atransf=exp, at=log(c(.65, .8, 1, 1.2, 1.5)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r fermented_hf dosres plot lin fermented_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("High-fat fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r fermented_hf dosres plot quad fermented_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("High-fat fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis fermented_hf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "fermented_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators fermented_hf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r fermented_hf confounders fermented_hf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "fermented_hf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_hf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r fermented_hf sensitivity analysis fermented_hf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_hf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:7) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_hf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:7) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl fermented_hf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data fermented_hf}
df <- data_4 %>% filter(exposure == "fermented_hf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 5, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Low-fat fermented dairy

```{r indiviual meta-analysis fermented_lf}
# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data fermented_lf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
#knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95)) # Not working
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
#knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9)) # Not working

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison fermented_lf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction fermented_lf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r fermented_lf model fit plot fermented_lf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "fermented_lf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest fermented_lf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r fermented_lf forest fermented_lf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 8.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r fermented_lf publication plot fermented_lf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .17), atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4, 1.6)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r fermented_lf dosres plot lin fermented_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("Low-fat fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

```{r fermented_lf dosres plot quad fermented_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.7, 1.3, 0.1), limits = c(0.7, 1.3)) +
  xlab("Low-fat fermented dairy intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

## Moderation

```{r moderation analysis fermented_lf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "fermented_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators fermented_lf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r fermented_lf confounders fermented_lf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "fermented_lf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_lf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r fermented_lf sensitivity analysis fermented_lf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "fermented_lf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:7) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_lf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:7) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl fermented_lf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data fermented_lf}
df <- data_4 %>% filter(exposure == "fermented_lf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="fermented_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 6, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Total milk

```{r indiviual meta-analysis milk_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "milk_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data milk_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1


# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 20000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison milk_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction milk_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r milk_tot model fit plot milk_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "milk_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest milk_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```


## Forest plot

```{r milk_tot forest milk_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.4)), at=log(c(.6, .8, 1, 1.2, 1.4)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.66,-0.52, 0.51, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r milk_tot publication plot milk_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.75, .9, 1, 1.1, 1.3)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r milk_tot dosres plot lin milk_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 3.5, 2)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r milk_tot dosres plot quad milk_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 1.5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

## Moderation

```{r moderation analysis milk_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "milk_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators milk_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r milk_tot confounders milk_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "milk_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r milk_tot sensitivity analysis milk_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "milk_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl milk_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data milk_tot}
df <- data_4 %>% filter(exposure == "milk_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 7, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# High-fat milk

```{r indiviual meta-analysis milk_hf}
# Select dairy type
df <- data_4 %>% filter(exposure == "milk_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data milk_hf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
# quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
# summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
#predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
# modi_fp <- apply(grid, 1, function(p)
#   dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
#              type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
#              data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
# bfp <- which.min(sapply(modi_fp, AIC))
# grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# # Graphical prediction factional polynomial trend two-stage
# newdata %>%
#   bind_cols(
#     lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
#   ) %>%
#   gather(fracpol, pred, -dose) %>%
#   mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
#   ggplot(aes(dose, pred, group = fracpol)) +
#   geom_line(aes(col = best), size = 1) +
#   scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
#   scale_color_manual(values = c("grey", "black")) +
#   labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
#   theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
# knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
# knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
# knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
# knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:6) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(lin))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  #cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr),   Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin_os))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  # cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr_os))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad_os", "fp_os", "1-95", "2-95", "NULL", "NULL", "1-90", "2-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(lin_os, fixed = TRUE)

gof(quadr_os, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison milk_hf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction milk_hf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad_os %>% slice_min(pred), predQuad_os %>% filter(dose == 0.5), predQuad_os %>% filter(dose == 1), predQuad_os %>% filter(dose == 1.5), predQuad_os %>% filter(dose == 2), predQuad_os %>% filter(dose == 2.5), predQuad_os %>% filter(dose == 3), predQuad_os %>% filter(dose == 3.5), predQuad_os %>% filter(dose == 4), predQuad_os %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r milk_hf model fit plot milk_hf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "milk_hf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# # Plot quadratic trend
# with(predict(quadr, newdata, xref, exp = TRUE), {
#   lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
#   matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
# })
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# # Plot polyfractional trend
# with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
#   lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
#   matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
# })
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest milk_hf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r milk_hf forest milk_hf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.5, 2)), at=log(c(.5, .7, 1, 1.5, 2)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-1.42,-1.12), # position of additional columns
       xlim=c(-2.9, 1.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-2.72,-1.42,-1.12, 0.94, 1.52), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-2.9, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r milk_hf publication plot milk_hf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .4), atransf=exp, at=log(c(.3, .5, 1, 1.7, 3.0)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r milk_hf dosres plot lin milk_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("High-fat milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r milk_hf dosres plot quad milk_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad_os, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("High-fat milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis milk_hf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "milk_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators milk_hf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r milk_hf confounders milk_hf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "milk_hf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_hf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r milk_hf sensitivity analysis milk_hf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "milk_hf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_hf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()

for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))

```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl milk_hf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data milk_hf}
df <- data_4 %>% filter(exposure == "milk_hf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
# quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
# summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  # cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
# gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
# predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad_os %>% slice_min(pred), predQuad_os %>% filter(dose == 0.5), predQuad_os %>% filter(dose == 1), predQuad_os %>% filter(dose == 1.5), predQuad_os %>% filter(dose == 2), predQuad_os %>% filter(dose == 2.5), predQuad_os %>% filter(dose == 3), predQuad_os %>% filter(dose == 3.5), predQuad_os %>% filter(dose == 4), predQuad_os %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 17, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Low-fat milk

```{r indiviual meta-analysis milk_lf}
# Select dairy type
df <- data_4 %>% filter(exposure == "milk_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data milk_lf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
# knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
# knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison milk_lf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction milk_lf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r milk_lf model fit plot milk_lf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "milk_lf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest milk_lf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r milk_lf forest milk_lf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r milk_lf publication plot milk_lf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.75, .9, 1, 1.1, 1.3)),
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r milk_lf dosres plot lin milk_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r milk_lf dosres plot quad milk_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat milk intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis milk_lf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "milk_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators milk_lf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r milk_lf confounders milk_lf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "milk_lf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_lf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r milk_lf sensitivity analysis milk_lf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "milk_lf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_lf"))$max), 0.01)))

pred <- list()
slice_min <- list()
slice_max <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  slice_max[[i]] <- pred[[i]] %>% slice_max(pred)
  
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
slice_max <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_max)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl milk_lf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_max %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data milk_lf}
df <- data_4 %>% filter(exposure == "milk_lf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="milk_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 8, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Total yogurt

```{r indiviual meta-analysis yogurt_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data yogurt_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale),
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n,
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
#knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
#knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 200000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison yogurt_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction yogurt_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r yogurt_tot model fit plot yogurt_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "yogurt_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest yogurt_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```


## Forest plot

```{r yogurt_tot forest yogurt_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.5, 2)), at=log(c(.5, .7, 1, 1.5, 2)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-1.42,-1.12), # position of additional columns
       xlim=c(-2.9, 1.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-2.72,-1.42,-1.12, 0.94, 1.52), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-2.9, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r yogurt_tot publication plot yogurt_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .2), atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4, 1.6)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r yogurt_tot dosres plot lin yogurt_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

```{r yogurt_tot dosres plot quad yogurt_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Total yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis yogurt_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "yogurt_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators yogurt_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r yogurt_tot confounders yogurt_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "yogurt_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r yogurt_tot sensitivity analysis yogurt_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl yogurt_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data yogurt_tot}
df <- data_4 %>% filter(exposure == "yogurt_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 9, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# High-fat yogurt

```{r indiviual meta-analysis yogurt_hf}
# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data yogurt_hf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# # Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale),
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n,
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# # Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
#knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
#knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison yogurt_hf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction yogurt_hf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r yogurt_hf model fit plot yogurt_hf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "yogurt_hf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest yogurt_hf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r yogurt_hf forest yogurt_hf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.3, 3)), at=log(c(.3, .7, 1, 1.5, 2, 3)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-1.92,-1.52), # position of additional columns
       xlim=c(-3.9, 2.7), # width of full forest plot
       cex=1, header=FALSE)
text(c(-3.6,-1.89,-1.52, 1.42, 2.17), 8.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-3.9, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r yogurt_hf publication plot yogurt_hf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, 0.75), atransf=exp, at=log(c(.15, .30, .5, 1, 2.5, 5, 7.5)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r yogurt_hf dosres plot lin yogurt_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("High-fat yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r yogurt_hf dosres plot quad yogurt_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 2, 0.5), limits = c(0.5, 2)) +
  xlab("High-fat yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")
```

## Moderation

```{r moderation analysis yogurt_hf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "yogurt_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators yogurt_hf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r yogurt_hf confounders yogurt_hf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "yogurt_hf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_hf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r yogurt_hf sensitivity analysis yogurt_hf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_hf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:7) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_hf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:7) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl yogurt_hf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data yogurt_hf}
df <- data_4 %>% filter(exposure == "yogurt_hf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 10, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Low-fat yogurt

```{r indiviual meta-analysis yogurt_lf}
# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data yogurt_lf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# # Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale),
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n,
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# # Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
#knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
#knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp_os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison yogurt_lf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction yogurt_lf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r yogurt_lf model fit plot yogurt_lf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "yogurt_lf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```


## Highest vs. lowest

```{r highest lowest yogurt_lf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r yogurt_lf forest yogurt_lf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.5, 1.6)), at=log(c(.5, .6, .8, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-1,-0.8), # position of additional columns
       xlim=c(-1.8,1.2), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.72,-1,-0.8, 0.62, 0.97), 8.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.8, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r yogurt_lf publication plot yogurt_lf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, 0.2), atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4, 1.6)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r yogurt_lf dosres plot lin yogurt_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r yogurt_lf dosres plot quad yogurt_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 0.25)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Low-fat yogurt intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")
```

## Moderation

```{r moderation analysis yogurt_lf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "yogurt_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators yogurt_lf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r yogurt_lf confounders yogurt_lf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "yogurt_lf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_lf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r yogurt_lf sensitivity analysis yogurt_lf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "yogurt_lf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:7) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_lf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:7) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}
slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl yogurt_lf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data yogurt_lf}
df <- data_4 %>% filter(exposure == "yogurt_lf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="yogurt_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 11, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Total cheese

```{r indiviual meta-analysis cheese_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data cheese_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison cheese_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction cheese_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r cheese_tot model fit plot cheese_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "cheese_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest cheese_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r cheese_tot forest cheese_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.5, 2)), at=log(c(.5, .7, 1, 1.5, 2)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 10.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r cheese_tot publication plot cheese_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .07), atransf=exp, at=log(c(.8, 1, 1.2)), 
       label ="all", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r cheese_tot dosres plot lin cheese_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 1.5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Total cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r cheese_tot dosres plot quad cheese_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  coord_cartesian(ylim = c(0.75, 1.75)) +  # Set visible y-axis range
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Total cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")

```

## Moderation

```{r moderation analysis cheese_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "cheese_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators cheese_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r cheese_tot confounders cheese_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "cheese_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r cheese_tot sensitivity analysis cheese_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:9) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
slice_max <- list()
out_confounder_quadr <- list()
for (i in 1:9) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  slice_max[[i]] <- pred[[i]] %>% slice_max(pred)
  
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
slice_max <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_max)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl cheese_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_max %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data cheese_tot}
df <- data_4 %>% filter(exposure == "cheese_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 12, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# High-fat cheese

```{r indiviual meta-analysis cheese_hf}
# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data cheese_hf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 20000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison cheese_hf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction cheese_hf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r cheese_hf model fit plot cheese_hf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "cheese_hf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest cheese_hf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r cheese_hf forest cheese_hf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.5)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.49, 0.72), 9.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r cheese_hf publication plot cheese_hf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .1), atransf=exp, at=log(c(.75, .9, 1, 1.1, 1.3)),
       label ="all", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r cheese_hf dosres plot lin cheese_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 1.5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("High-fat cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r cheese_hf dosres plot quad cheese_hf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 1.5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("High-fat cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

## Moderation

```{r moderation analysis cheese_hf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "cheese_hf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators cheese_hf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r cheese_hf confounders cheese_hf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "cheese_hf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)

# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_hf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r cheese_hf sensitivity analysis cheese_hf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) # Not in dataset
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_hf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:8) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_hf"))$max), 0.01)))

pred <- list()
slice_min <- list()
slice_max <- list()
out_confounder_quadr <- list()
for (i in 1:8) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  slice_max[[i]] <- pred[[i]] %>% slice_max(pred)
  
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
slice_max <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_max)))
out_confounder_quadr <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_confounder_quadr)))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl cheese_hf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_max %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data cheese_hf}
df <- data_4 %>% filter(exposure == "cheese_hf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_hf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 13, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Low-fat cheese

```{r indiviual meta-analysis cheese_lf}
# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data cheese_lf}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
# knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
# knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison cheese_lf, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction cheese_lf, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r cheese_lf model fit plot cheese_lf, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "cheese_lf"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest cheese_lf, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Forest plot

```{r cheese_lf forest cheese_lf, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.7, 1.6)), at=log(c(.7, .8, .9, 1, 1.1, 1.3, 1.6)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,1), # width of full forest plot
       cex=1, header=FALSE)
text(c(-1.22,-0.68,-0.53, 0.55, 0.82), 9.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r cheese_lf publication plot cheese_lf, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, .2), atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4, 1.6)), 
       label ="out", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r cheese_lf dosres plot lin cheese_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.8, 1.8)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Low-fat cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r cheese_lf dosres plot quad cheese_lf, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Low-fat cheese intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis cheese_lf, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "cheese_lf") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators cheese_lf, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r cheese_lf confounders cheese_lf, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "cheese_lf")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_lf"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r cheese_lf sensitivity analysis cheese_lf, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) # Not in dataset
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "cheese_lf") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:8) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_lf"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:8) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl cheese_lf, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data cheese_lf}
df <- data_4 %>% filter(exposure == "cheese_lf") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cheese_lf"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 14, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Total cream

```{r indiviual meta-analysis cream_tot}
# Select dairy type
df <- data_4 %>% filter(exposure == "cream_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data cream_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cream_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:8) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 20000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "4-95", "1-90", "2-90", "3-90", "4-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison cream_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction cream_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r cream_tot model fit plot cream_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "cream_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest cream_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```


## Forest plot

```{r cream_tot forest cream_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.3, 3)), at=log(c(.3, .6, 1, 2, 3)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-3.1,-2.33), # position of additional columns
       xlim=c(-5.8,3.8), # width of full forest plot
       cex=1, header=FALSE)
text(c(-5.4,-3.1,-2.33, 1.83, 3.07), 9.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-5.8, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r cream_tot publication plot cream_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, 2.6), atransf=exp, at=log(c(.001, .1, .1, .2, .4, 12, 200, 2000)), 
       label ="all", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r cream_tot dosres plot lin cream_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.25, 1.25)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Cream intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r cream_tot dosres plot quad cream_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred))  + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylim(c(0.5, 1.5)) +
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 6.5, 1)) +
  xlab("Cream intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank())
```

## Moderation

```{r moderation analysis cream_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "cream_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators cream_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r cream_tot confounders cream_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "cream_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cream_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r cream_tot sensitivity analysis cream_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "cream_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:8) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cream_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:8) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl cream_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data cream_tot}
df <- data_4 %>% filter(exposure == "cream_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="cream_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

```{r remove 15, echo=FALSE}
rm(df, lin, lin_os, lin_pr, modi_fp, modi_fp_os, newdata,  out_spl_models, pred1, pred2, pred3, pred4, predLin, predQuad_os, predSpl, quadr, quadr_confounder, quadr_l1o, quadr_results, df_weights, df2, grid, knots_list, lfk, lin_confounder, lin_exl, lin_l1o, lin_results, lin.mod, model_comparison, pred, predQuad, quadr_os, quadr.mod, slice_min, spl, spl_models, spl_results, spl.mod., bfp, bfp_os, i, knots, num_params, out_final, out_moderators, out_results_exl, out_results_exl2, data_mod, out_confounder, out_confounder_lin, out_confounder_quadr, spl.mod, scale, shift, studyname_abv, xref)
```

# Total ice cream

```{r indiviual meta-analysis creamice_tot}
# Select dairy type
# Select categorical RRs from fully adjusted model
df <- data_4 %>% filter(exposure == "creamice_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Meta-analysis of each study separately to obtain study effect estimate and rma to obtain study specific weights, in rma.uni linear REMA with DL for I2 estimates consistent with dosresmeta
df2 <- df %>%
  group_by(id) %>%
  nest() %>%
  mutate(
    lin = map(data, ~ dosresmeta(logrr ~ dose, lb = LB, ub = UB, type = type, cases = cases, n = n, data = .x)),
    yi = map_dbl(lin, ~ coef(.x)),
    vi = map_dbl(lin, ~ vcov(.x)),
    studyname = map_chr(data, ~ as.character(.x$studyname[1])),
    studyname_abv = map_chr(data, ~ as.character(.x$studyname_abv[1])),
    n_tot = map_dbl(data, ~ sum(.x$n)),
    n_cases = map_dbl(data, ~ sum(.x$cases)),
    FU = map_dbl(data, ~ as.numeric(.x$FU_duration[1])),
    year = map_chr(data, ~ as.character(.x$year[1])),
    type = map_chr(data, ~ as.character(.x$type[1])))
df2 <- df2 %>% arrange(yi) # Arrange by effect size for forest plot
lin_pr <- rma.uni(yi = yi, vi = vi, data = df2, method = "DL", slab=paste(studyname_abv, year, sep=", "))

# Merge weights to be used in final plot
df_weights <- as.data.frame(weights(lin_pr))
df_weights <- rownames_to_column(df_weights, var = "studyname_abv")
df_weights$studyname_abv = substr(df_weights$studyname_abv,1,nchar(df_weights$studyname_abv)-6)
names(df_weights) <- c("studyname_abv", "weights")
df <- merge(df, df_weights, by = "studyname_abv")

```

## Model fit assesment

```{r fit model data creamice_tot}
# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage")
summary(quadr_os)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="creamice_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Non-linear fractional polynomial

# Combination of different power terms
grid <- fpgrid()
shift <- 0.5
scale <- 1

# Factional polynomial trend
modi_fp <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "2stage"))
# Factional polynomial trend one-stage
modi_fp_os <- apply(grid, 1, function(p)
  dosresmeta(formula = logrr ~ fracpol(dose, p = p, shift = shift, scale = scale), 
             type = type, id = id, lb = LB, ub = UB, cases = cases, n = n, 
             data = df, proc = "1stage"))

# Power terms that result in "best" (lowest AIC) model
bfp <- which.min(sapply(modi_fp, AIC))
grid[bfp, ]

bfp_os <- which.min(sapply(modi_fp_os, AIC))
grid[bfp_os, ]

# Graphical prediction factional polynomial trend two-stage
newdata %>%
  bind_cols(
    lapply(modi_fp, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)
  ) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp, labels = c("p(3, 3)", "Other"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c("grey", "black")) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") +
  theme_classic()

# Graphical prediction factional polynomial trend one-stage
newdata %>%
  bind_cols(lapply(modi_fp_os, function(m) predict(m, newdata = newdata, exp = TRUE)$pred)) %>%
  gather(fracpol, pred, -dose) %>%
  mutate(best = factor(fracpol == bfp_os, labels = c("Other", "p(-1, -0.5)"))) %>%
  ggplot(aes(dose, pred, group = fracpol)) +
  geom_line(aes(col = best, alpha = best), size = 1) +
  scale_y_continuous(trans = "log", breaks = c(.6, .75, 1, 1.5, 2)) +
  scale_color_manual(values = c(`p(-1, -0.5)` = "black", "Other" = "grey")) +
  scale_alpha_manual(values = c(`p(-1, -0.5)` = 1, "Other" = .2)) +
  labs(x = "Dose", y = "Relative risk", col = "Frac Pol") + guides(alpha = F) +
  theme_classic()

# Splines

# Create list with knots to try 
knots_list <- list()
knots_list[[1]] <- quantile(df$dose, c(.05, .5, .95))
knots_list[[2]] <- quantile(df$dose, c(.05, .35, .65, .95))
knots_list[[3]] <- quantile(df$dose, c(.05, .25, .5, .75, .95))
# knots_list[[4]] <- quantile(df$dose, c(.05, .2, .4, .6, .8, .95))
knots_list[[5]] <- quantile(df$dose, c(.1, .5, .9))
knots_list[[6]] <- quantile(df$dose, c(.1, .35, .65, .9))
knots_list[[7]] <- quantile(df$dose, c(.1, .25, .5, .75, .9))
# knots_list[[8]] <- quantile(df$dose, c(.1, .2, .4, .6, .8, .9))

# Create a list to store the spline models and output
spl_models <- list()
out_spl_models <- list()
# Iterate over different sets of knots
for (i in 1:7) {
  spl_models[[i]] <- dosresmeta(formula = logrr ~ rcs(dose, knots_list[[i]]), id = id, type = type, lb = LB, ub = UB,  
                                cases = cases, n = n, data = df, proc = "1stage",
                                control = list(maxiter = 10000))
  num_params  <- length(coef(spl_models[[i]]))
  out_spl_models[[i]] <- cbind(logLik = summary(spl_models[[i]])$logLik, AIC = summary(spl_models[[i]])$AIC, 
                               BIC = summary(spl_models[[i]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(spl_models[[i]]) - logLik(quadr))), df = 1))[1],
                               pWald = round(waldtest(b = coef(spl_models[[i]]), Sigma = vcov(spl_models[[i]]), Terms = (num_params - 1):(num_params))[["chitest"]][3]))
}
# Combine results into a data frame
out_spl_models <- do.call(rbind, out_spl_models)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3])),  
  cbind(logLik = summary(modi_fp[[bfp]])$logLik, AIC = summary(modi_fp[[bfp]])$AIC, BIC = summary(modi_fp[[bfp]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp[[bfp]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp[[bfp]]), Sigma = vcov(modi_fp[[bfp]]), Terms = 2)[["chitest"]][3])),
  
  cbind(logLik = summary(modi_fp_os[[bfp_os]])$logLik, AIC = summary(modi_fp_os[[bfp_os]])$AIC, BIC = summary(modi_fp_os[[bfp_os]])$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(modi_fp_os[[bfp_os]]) - logLik(quadr))), df = 1))[1], pWald = round(waldtest(b = coef(modi_fp_os[[bfp_os]]), Sigma = vcov(modi_fp_os[[bfp_os]]), Terms = 2)[["chitest"]][3]))
))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os", "fp", "fp os", "1-95", "2-95", "3-95", "NULL", "1-90", "2-90", "3-90"), rbind(model_comparison, out_spl_models))

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

spl <- dosresmeta(formula = logrr ~ rcs(dose, knots), id = id, type = type, lb = LB, ub = UB,  
                  cases = cases, n = n, data = df, proc = "1stage",
                  control = list(maxiter = 10000))
summary(spl)
predSpl <- predict(spl, newdata, exp = TRUE)

# Goodness-of-fit
gof(lin, fixed = TRUE)

gof(quadr, fixed = TRUE)

gof(spl, fixed = TRUE)
```

### Best fitting model based on BIC and p value for non-linearity.

```{r print model_comparison creamice_tot, echo = FALSE}
model_comparison %>% arrange(BIC) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

### Predict RR at certain intake levels

```{r print prediction creamice_tot, echo = FALSE}
# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Predict linear trend at max intake
predict(lin, delta = max(df$dose), expo = TRUE)
max(df$dose)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)

```

### Model fit plot

```{r creamice_tot model fit plot creamice_tot, fig.height=9, fig.width=9, echo=FALSE}
# Comparing different strategies
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr %>% filter(exposure == "creamice_tot"))$max), 0.01)))

# Plot linear trend
with(predict(lin, newdata, xref, exp = TRUE),{
  plot(get("dose"), pred, type = "l", ylim = c(0.5, 1.5),
       ylab = "Relative risk", xlab = "Dairy intake, servings/d",
       log = "y", bty = "l", las = 1, lwd = 2)
  matlines(get("dose"), cbind(ci.ub, ci.lb),
           col = 1, lty = "dashed", lwd = 2)
})
# Plot quadratic trend
with(predict(quadr, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot quadratic trend OS
with(predict(quadr_os, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "red", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "red", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp[[bfp]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "orange", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "orange", lty = "dashed")
})
# Plot polyfractional trend OS
with(predict(modi_fp_os[[bfp_os]], newdata, exp = TRUE), {
  lines(newdata$dose, pred, col = "purple", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "purple", lty = "dashed")
})
# Plot spline trend
with(predict(spl, newdata, xref, exp = TRUE), {
  lines(newdata$dose, pred, col = "green", lty = 1, lwd = 2)
  matlines(newdata$dose, cbind(ci.ub, ci.lb), col = "green", lty = "dashed")
})
# Add original dose points
rug(df$dose)
# Add a legend
legend("topright", legend = c("Linear Trend", "Quadratic Trend", "Quadratic Trend OS", "Modi FP", "Modi FP OS", "Spline"),
       col = c("black", "red", "red", "orange", "purple", "green"), lty = c(1, 1, 1, 1, 1, 1), lwd = 2)

```

## Highest vs. lowest

```{r highest lowest creamice_tot, fig.height=5, fig.width=9, echo=FALSE}
df_sel <- df %>% group_by(id) %>% filter(exposure_cat == max(exposure_cat)) 
df_sel <- df_sel %>% arrange(logrr) # Arrange by effect size for forest plot
lin_hl <- rma.uni(yi = logrr, sei = standard_error, data = df_sel, method = "DL", slab=paste(studyname_abv, year, sep=", "))

summary(lin_hl)

forest(lin_hl,xlab="Relative risk", atransf = exp, 
       slab=df_sel$studyname,
       alim=log(c(.5, 1.5)), at=log(c(.5, .7, .9, 1, 1.1, 1.3, 1.5)), showweights = T,
       ilab.xpos=c(-0.67,-0.52), # position of additional columns
       xlim=c(-1.3,0.9), # width of full forest plot
       cex=1, header=FALSE)
text(-1.3, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_hl$k - lin_hl$p),,") = ",
                                            .(formatC(lin_hl$QE, digits=2, format="f")), ", p = ", .(formatC(lin_hl$QEp, digits=2, format="f")), "; ", I^2, " = ",                                            .(formatC(lin_hl$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```


## Forest plot

```{r creamice_tot forest creamice_tot, fig.height=5, fig.width=9, echo=FALSE}
forest(lin_pr,xlab="Relative risk", atransf = exp, 
       slab=paste0(df2$studyname),
       alim=log(c(.1, 4)), at=log(c(.3, .6, 1, 2, 3)), showweights = T,
       ilab=cbind(df2$n_cases, df2$n_tot), 
       ilab.xpos=c(-4.1,-3.33), # position of additional columns
       xlim=c(-7.8,4.8), # width of full forest plot
       cex=1, header=FALSE)
text(c(-7.2,-4.1,-3.33, 2.23, 3.87), 9.5, c("Study","Cases","N", "Weight", "RR (95%CI)"),cex=1, font=2) # add column names (trial and error for location)
text(-7.8, -1.7, pos=4, cex=1, bquote(paste("Q(",.(lin_pr$k - lin_pr$p),,") = ",
                                            .(formatC(lin_pr$QE, digits=2, format="f")), ", p = ", .(formatC(lin_pr$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                            .(formatC(lin_pr$I2, digits=1, format="f")), "%"))) # Add heterogeneity statistics below plot
```

## Publication bias plot

```{r creamice_tot publication plot creamice_tot, fig.height=5, fig.width=10, echo=FALSE}
par(mfrow=c(1,2))
funnel(lin_pr, digits=2L, ylim=c(0, 2.5), atransf=exp, at=log(c(0.001, 0.01, 0.1 ,1,  10 ,100, 1000)), 
       label ="all", level=c(95, 99), 
       shade=c("white", "gray55", "gray75"), legend=list(show="cis"),
       xlab = "Relative risk",
       ylab = "Standard error of (log)relative risk")
# Egger's test
regtest(lin_pr)
# Doi plot for Asymmetry and LFK Index
lfk <- lfkindex(yi, sqrt(vi), data = df2)
lfk
doiplot(lfk,
        xlab = "log(Relative risk)",
        ylab = "|Z-score|",
        lfkindex = TRUE,
        pos.lfkindex = "topleft")
```

## Dosres plot

```{r creamice_tot dosres plot lin creamice_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predLin, aes(x = get("dose"), y = pred))+ 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray") +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 3, 0.1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Ice cream intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

```{r creamice_tot dosres plot quad creamice_tot, fig.height=3.2, fig.width=3.2, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
ggplot(predQuad, aes(x = get("dose"), y = pred)) + 
  geom_line(data = df, aes(x = dose, y = effectestimate, group = studyname), size = 0.7, color = "lightslategray") +
  geom_point(data = df, aes(x = dose, y = effectestimate), size = df$weights/10, color = "lightslategray")+
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), fill = "lightgrey", linetype = "dotted", 
              color = "black", size = 1, alpha = 0.3) +
  geom_line(color = "black", size = 1.5, n = 651) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  ylab("Relative risk") +
  scale_x_continuous(breaks = seq(0, 3, 0.1)) +
  scale_y_continuous(breaks = seq(0.5, 1.5, 0.25), limits = c(0.5, 1.5)) +
  xlab("Ice cream intake, servings/d") +
  theme(
    axis.text = element_text(color = "black", family = "serif", size = 11),  # Set axis text color, font, and size
    axis.title = element_text(color = "black", family = "serif", size = 11, face = "bold"),  # Set axis title color, font, and size
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    panel.border = element_blank(), 
    panel.background = element_blank()) 
```

## Moderation

```{r moderation analysis creamice_tot, echo = TRUE}
###  Meta-regression with three moderators
df <- data_4 %>% filter(exposure == "creamice_tot") 
df$id <- droplevels(df$id)
df$moderator_prediabetes_assesment <- droplevels(df$moderator_prediabetes_assesment)

# Optimal spline model as shown in model_comparison
knots <- quantile(df$dose, c(.05, .5, .95))

# Linear trend
lin.mod <- as.list(1:4)
lin.mod[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[2]] <- dosresmeta(logrr ~ dose, mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[3]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
lin.mod[[4]] <- dosresmeta(logrr ~ dose, mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "1stage", data = df)
# Non-linear (quadratic) trend
quadr.mod <- as.list(1:4)
quadr.mod[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
quadr.mod[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df)
## Non-linear (quadratic) trend
spl.mod <- as.list(1:4)
spl.mod[[1]] <- dosresmeta(logrr ~ rcs(dose, knots), id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[2]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ FU_duration, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))
spl.mod[[3]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_yeardairyintake, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 1000000000))
spl.mod[[4]] <- dosresmeta(logrr ~ rcs(dose, knots), mod = ~ moderator_prediabetes_assesment, id = id, lb = LB, ub = UB, type = type, proc = "1stage", cases = cases, n = n, data = df, control = list(maxiter = 10000))

# Extract results
lin_results <- list()
quadr_results <- list()
spl_results <- list()
for (i in 1:4) {
  lin_results[[i]] <- cbind(logLik = summary(lin.mod[[i]])$logLik, AIC = summary(lin.mod[[i]])$AIC, BIC = summary(lin.mod[[i]])$BIC, plogLik = "", pWald = "",
                            R2 = round(gof(lin.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(lin.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  quadr_results[[i]] <- cbind(logLik = summary(quadr.mod[[i]])$logLik, AIC = summary(quadr.mod[[i]])$AIC, BIC = summary(quadr.mod[[i]])$BIC, 
                              plogLik = unclass(1 - pchisq((2 * (logLik(quadr.mod[[i]]) - logLik(lin.mod[[i]]))), df = 1))[1], pWald = waldtest(b = coef(quadr.mod[[i]]), Sigma = vcov(quadr.mod[[i]]), Terms = 2)[["chitest"]][3],
                              R2 = round(gof(quadr.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), pD = round(gof(quadr.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}
for (i in 1:4) {
  spl_results[[i]] <- cbind(logLik = summary(spl.mod[[i]])$logLik, AIC = summary(spl.mod[[i]])$AIC, BIC = summary(spl.mod[[i]])$BIC, 
                            plogLik = unclass(1 - pchisq((2 * (logLik(spl.mod[[i]]) - logLik(quadr.mod[[i]]))), df = 1))[1], 
                            pWald = waldtest(b = coef(spl.mod[[i]]), Sigma = vcov(spl.mod[[i]]), Terms = 1:nrow(vcov(spl.mod[[i]])))[["chitest"]][3],
                            R2 = round(gof(spl.mod[[i]], fixed = TRUE)[["R2"]],3), D = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["D"]],3), 
                            pD = round(gof(spl.mod[[i]], fixed = TRUE)[["deviance"]][["p"]],3))
}

# Combine results into a data frame
out_moderators <- as.data.frame(do.call(rbind, c(lin_results, quadr_results, spl_results)))
```

* Supplemental table. Goodness-of fit tests for models with potential moderators of the association between dairy foods and prediabetes risk based on one-stage dose-response meta-regression
```{r print out_moderators creamice_tot, echo = FALSE}
out_moderators %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Confounders

*Supplemental table.* Associations between dairy foods and prediabetes risk based on linear dose-response slopes for different confounder models

```{r creamice_tot confounders creamice_tot, echo = FALSE}
# Different confounder models

# Select dairy type and confounder model
lin_confounder <- list()
quadr_confounder <- list()
data_5 <- data_3 %>% filter(exposure_cat != "continious" & exposure == "creamice_tot")
data_5$id <- droplevels(data_5$id)
df <- data_5 %>% filter(confounder_model == "1")
lin_confounder[[1]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[1]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "2") 
lin_confounder[[2]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[2]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "3")
lin_confounder[[3]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[3]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
df <- data_5 %>% filter(confounder_model == "4")
lin_confounder[[4]] <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)
quadr_confounder[[4]] <- dosresmeta(logrr ~ dose + I(dose^2), id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, proc = "2stage", data = df)


# Combine output from four confounder models
out_confounder <- list()
for (i in 1:4) { 
  out_confounder[[i]] <- cbind(RR = exp(coef(summary(lin_confounder[[i]]))[1]), LL = exp(coef(summary(lin_confounder[[i]]))[5]), UL = exp(coef(summary(lin_confounder[[i]]))[6]))
}

# Combine results into a data frame
out_confounder_lin <- as.data.frame(do.call(rbind, out_confounder))
out_confounder_lin %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="creamice_tot"))$max), 0.01)))
pred1 <- predict(quadr_confounder[[1]], newdata, exp = TRUE)
pred2 <- predict(quadr_confounder[[2]], newdata, exp = TRUE)
pred3 <- predict(quadr_confounder[[3]], newdata, exp = TRUE)
pred4 <- predict(quadr_confounder[[4]], newdata, exp = TRUE)

out_confounder_quadr <- rbind(cbind(mod = "pred1", rbind(pred1 %>% slice_min(pred), pred1 %>% filter(dose == 0.5), pred1 %>% filter(dose == 1), pred1 %>% filter(dose == 1.5), pred1 %>% filter(dose == 2), pred1 %>% filter(dose == 2.5), pred1 %>% filter(dose == 3), pred1 %>% filter(dose == 3.5), pred1 %>% filter(dose == 4), pred1 %>% filter(dose == 4.5), pred1 %>% filter(dose == 5), pred1 %>% filter(dose == 5.5), pred1 %>% filter(dose == 6), pred1 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred2", rbind(pred2 %>% slice_min(pred), pred2 %>% filter(dose == 0.5), pred2 %>% filter(dose == 1), pred2 %>% filter(dose == 1.5), pred2 %>% filter(dose == 2), pred2 %>% filter(dose == 2.5), pred2 %>% filter(dose == 3), pred2 %>% filter(dose == 3.5), pred2 %>% filter(dose == 4), pred2 %>% filter(dose == 4.5), pred2 %>% filter(dose == 5), pred2 %>% filter(dose == 5.5), pred2 %>% filter(dose == 6), pred2 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred3", rbind(pred3 %>% slice_min(pred), pred3 %>% filter(dose == 0.5), pred3 %>% filter(dose == 1), pred3 %>% filter(dose == 1.5), pred3 %>% filter(dose == 2), pred3 %>% filter(dose == 2.5), pred3 %>% filter(dose == 3), pred3 %>% filter(dose == 3.5), pred3 %>% filter(dose == 4), pred3 %>% filter(dose == 4.5), pred3 %>% filter(dose == 5), pred3 %>% filter(dose == 5.5), pred3 %>% filter(dose == 6), pred3 %>% filter(dose == max(df$dose)))), 
                              cbind(mod = "pred4", rbind(pred4 %>% slice_min(pred), pred4 %>% filter(dose == 0.5), pred4 %>% filter(dose == 1), pred4 %>% filter(dose == 1.5), pred4 %>% filter(dose == 2), pred4 %>% filter(dose == 2.5), pred4 %>% filter(dose == 3), pred4 %>% filter(dose == 3.5), pred4 %>% filter(dose == 4), pred4 %>% filter(dose == 4.5), pred4 %>% filter(dose == 5), pred4 %>% filter(dose == 5.5), pred4 %>% filter(dose == 6), pred4 %>% filter(dose == max(df$dose)))))

out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)

# I2 and Q statistics are only available in the summary
summary(lin_confounder[[1]])
summary(lin_confounder[[2]])
summary(lin_confounder[[3]])
summary(lin_confounder[[4]])

summary(quadr_confounder[[1]])
summary(quadr_confounder[[2]])
summary(quadr_confounder[[3]])
summary(quadr_confounder[[4]])
```

## Sensitivity analysis

```{r creamice_tot sensitivity analysis creamice_tot, echo = FALSE}
# First approach: linear with rma.uni

# Excluding 1 study at a time
lin_exl <- list()
lin_exl[[1]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "AD"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[2]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[3]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "FHS-OC"), method = "DL", slab=paste(studyname_abv, year, sep=", ")) #Not in data
lin_exl[[4]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[5]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "HS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[6]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "LS"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[7]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-I"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[8]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-II"), method = "DL", slab=paste(studyname_abv, year, sep=", "))
lin_exl[[9]] <- rma.uni(yi = yi, vi = vi, data = subset(df2, studyname_abv != "RS-III"), method = "DL", slab=paste(studyname_abv, year, sep=", "))

out_results_exl <- list()
for (i in 1:9) {
  out_results_exl[[i]] <- cbind(RR = exp(coef(summary(lin_exl[[i]]))[1]), LL = exp(coef(summary(lin_exl[[i]]))[5]), UL = exp(coef(summary(lin_exl[[i]]))[6]),
                                I2 = lin_exl[[i]][["I2"]], QE = lin_exl[[i]][["QE"]], QEp = lin_exl[[i]][["QEp"]])
  
}
# Combine results into a data frame
studyname_abv <- c("AD", "FS", "FHS-OC", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl <- cbind(studyname_abv, do.call(rbind, out_results_exl))

# Second approach is not working: 
## the 2stage approach requires that each study provides at least p non-referent obs
## the 1stage approach gives an error for linear fits and does not provide heterogeneity statistics

# Select dairy type
df <- data_4 %>% filter(exposure == "creamice_tot") 
df$id <- droplevels(df$id)

# Excluding 1 study at a time # Two stage not possible
# leave-one-out
lin_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose, id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

quadr_l1o <- lapply(unique(df$id), function(i)
  dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, proc = "1stage", data = subset(df, id != i))
)

# graphical presentation
newdata %>% cbind(
  do.call("cbind",
          lapply(quadr_l1o, function(m) predict(m, newdata = ., exp = TRUE)$pred)
  )) %>%
  gather(study, pred, -dose) %>%
  ggplot(aes(dose, pred, col = study)) +
  geom_line() +
  scale_y_continuous(trans = "log") +
  labs(x = "Dose", y = "Relative risk", col = "Excluded study") +
  theme_classic()

# Extract RR at intake
out_results_exl2 <- list()
for (i in 1:8) {
  out_results_exl2[[i]] <- cbind(intake = "1", RR = exp(coef(summary(lin_l1o[[i]]))[1]), LL = exp(coef(summary(lin_l1o[[i]]))[5]), UL = exp(coef(summary(lin_l1o[[i]]))[6]), I2 = lin_l1o[[i]][["I2"]], QE = lin_l1o[[i]][["QE"]], QEp = lin_l1o[[i]][["QEp"]])
}

# Combine results into a data frame
studyname_abv <- c("AD", "FS", "HS-I", "HS-II", "LS", "RS-I", "RS-II", "RS-III")
out_results_exl2 <- as.data.frame(cbind(studyname_abv, do.call(rbind, out_results_exl2)))
out_results_exl2 <- out_results_exl2 %>% arrange(RR)

# Prediction dataset
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="creamice_tot"))$max), 0.01)))

pred <- list()
slice_min <- list()
out_confounder_quadr <- list()
for (i in 1:8) {
  pred[[i]] <- predict(quadr_l1o[[i]], newdata, exp = TRUE)
  if (summary(pred[[i]]$pred)[[6]] > 1) {
    slice_min[[i]] <- pred[[i]] %>% slice_max(pred)
  } else {
    slice_min[[i]] <- pred[[i]] %>% slice_min(pred)
  }
  out_confounder_quadr[[i]] <- cbind(mod = i, rbind(pred[[i]] %>% slice_min(pred), pred[[i]] %>% filter(dose == 0.5), pred[[i]] %>% filter(dose == 1), pred[[i]] %>% filter(dose == 1.5), pred[[i]] %>% filter(dose == 2), pred[[i]] %>% filter(dose == 2.5), pred[[i]] %>% filter(dose == 3), pred[[i]] %>% filter(dose == 3.5), pred[[i]] %>% filter(dose == 4), pred[[i]] %>% filter(dose == max(df$dose))))
}

slice_min <- as.data.frame(cbind(studyname_abv, do.call(rbind, slice_min)))
names(out_confounder_quadr) <- studyname_abv
out_confounder_quadr <- as.data.frame(do.call(rbind, out_confounder_quadr))
```

*Supplemental table.* Sensitivity analyses of associations between dairy foods and prediabetes risk based on one-stage dose-response meta-analysis and two-stage linear mixed effect meta-analysis

```{r print out_results_exl creamice_tot, echo = FALSE}
out_results_exl %>% arrange(estimate) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_results_exl2 %>% arrange(RR) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
slice_min %>% arrange(pred) %>% kbl() %>% kable_paper("hover", full_width = FALSE)
out_confounder_quadr %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```

## Fixed effect sensitivity analysis

```{r fit fixed effects model data creamice_tot}
df <- data_4 %>% filter(exposure == "creamice_tot") 
df$id <- droplevels(df$id)

# Linear trend
lin <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(lin)

# Linear trend one-stage (warning)
lin_os <- dosresmeta(logrr ~ dose, id = id, lb = LB, ub = UB, type = type, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(lin_os)

# Non-linear quadratic trend
quadr <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "2stage", method = "fixed")
summary(quadr)

# Non-linear quadratic trend one-stage
quadr_os <- dosresmeta(formula = logrr ~ dose + I(dose^2), id = id, type = type, lb = LB, ub = UB, cases = cases, n = n, data = df, proc = "1stage", method = "fixed")
summary(quadr_os)

# Fit statistics
model_comparison <- as.data.frame(rbind(
  cbind(logLik = summary(lin)$logLik, AIC = summary(lin)$AIC, BIC = summary(lin)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(lin_os)$logLik, AIC = summary(lin_os)$AIC, BIC = summary(lin_os)$BIC, plogLik = "", pWald = ""),
  cbind(logLik = summary(quadr)$logLik, AIC = summary(quadr)$AIC, BIC = summary(quadr)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr), Sigma = vcov(quadr), Terms = 2)[["chitest"]][3])),
  cbind(logLik = summary(quadr_os)$logLik, AIC = summary(quadr_os)$AIC, BIC = summary(quadr_os)$BIC, plogLik = unclass(1 - pchisq((2 * (logLik(quadr_os) - logLik(lin))), df = 1))[1], pWald = round(waldtest(b = coef(quadr_os), Sigma = vcov(quadr_os), Terms = 2)[["chitest"]][3]))))

model_comparison <- model_comparison %>% mutate(BIC = as.numeric(BIC))
model_comparison <- cbind(mod = c("lin", "lin_os", "quad", "quad_os"), model_comparison)
model_comparison %>% arrange(BIC)

# Goodness-of-fit
gof(lin, fixed = TRUE)
gof(quadr, fixed = TRUE)

# Prediction dataset
xref <- 0
newdata <- data.frame(dose = c(xref, seq(0, max((out_chr%>%filter(exposure=="creamice_tot"))$max), 0.01)))
predLin <- predict(lin, newdata, exp = TRUE)
predQuad <- predict(quadr, newdata, exp = TRUE)
predQuad_os <- predict(quadr_os, newdata, exp = TRUE)

# Predict linear trend at intake of 1 serving/day
predict(lin, delta = 1, expo = TRUE)

# Lowest/highest RR in non-linear model
out_final <- rbind(predQuad %>% slice_min(pred), predQuad %>% filter(dose == 0.5), predQuad %>% filter(dose == 1), predQuad %>% filter(dose == 1.5), predQuad %>% filter(dose == 2), predQuad %>% filter(dose == 2.5), predQuad %>% filter(dose == 3), predQuad %>% filter(dose == 3.5), predQuad %>% filter(dose == 4), predQuad %>% filter(dose == max(df$dose)))

out_final %>% kbl() %>% kable_paper("hover", full_width = FALSE)
```
